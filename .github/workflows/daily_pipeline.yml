name: Pipeline Di√°rio - Barbearia

on:
  workflow_dispatch:
  schedule:
    - cron: '0 11 * * *'

jobs:
  run_pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install
        run: pip install -r requirements.txt

      - name: 1. Extra√ß√£o e Load (MotherDuck)
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }} # Nova secret
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: "SEU_ID"
        run: python src/extract.py

      - name: 2. Transforma√ß√£o (dbt Cloud)
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }} # Dbt precisa para conectar
        run: |
          cd dbt_project
          dbt run --profiles-dir .

      - name: 3. Report Financeiro e IA
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }} # Python precisa para ler
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # ... telegram vars ...
        run: python src/send_email.py

      # Notifica√ß√£o de Falha Cr√≠tica
      - name: üö® Notificar Falha de Pipeline
        if: failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: "SEU_NUMERO_DO_TOPICO"
        run: |
          curl -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_CHAT_ID \
          -d message_thread_id=$TELEGRAM_TOPIC_ID \
          -d text="üö® *CRITICAL ERROR*: O Pipeline FALHOU no GitHub Actions! Verifique os logs." \
          -d parse_mode="Markdown"